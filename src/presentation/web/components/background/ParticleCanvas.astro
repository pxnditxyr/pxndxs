<canvas
  id="particleCanvas"
  class="fixed top-0 left-0 w-full h-full pointer-events-none z-0 opacity-30 dark:opacity-40"
></canvas>

<script>
  interface Mouse {
    x: number | null
    y: number | null
    radius: number
  }

  const canvas = document.getElementById( 'particleCanvas' ) as HTMLCanvasElement
  if ( canvas ) {

    const ctx = canvas.getContext( '2d' )

    if ( ctx ) {
      let particles: Particle[] = []
      let mouse: Mouse = { x: null, y: null, radius: 150 }

      class Particle {

        x: number
        y: number
        size: number
        speedX: number
        speedY: number

        constructor () {
          this.x = Math.random() * canvas.width
          this.y = Math.random() * canvas.height

          this.size = Math.random() * 2 + 1
          this.speedX = Math.random() * 1.5 - 0.75
          this.speedY = Math.random() * 1.5 - 0.75
        }

        update () {
          this.x += this.speedX
          this.y += this.speedY

          if ( this.x > canvas.width || this.x < 0 )
            this.speedX = -this.speedX
          if ( this.y > canvas.height || this.y < 0 )
            this.speedY = -this.speedY

          if ( mouse.x !== null && mouse.y != null ) {
            let dx = mouse.x - this.x
            let dy = mouse.y - this.y
            let distance = Math.sqrt( dx * dx + dy * dy )

            if ( distance < mouse.radius ) {
              const forceDirectionX = dx / distance
              const forceDirectionY = dy / distance
              const force = ( mouse.radius - distance ) / mouse.radius
              const directionX = forceDirectionX * force * this.size
              const directionY = forceDirectionY * force * this.size

              this.x -= directionX
              this.y -= directionY
            }
          }
        }

        draw () {
          if ( !ctx ) return

          const isDark = document.documentElement.classList.contains( 'dark' )
          ctx.fillStyle = isDark ? 'rgba( 255, 255, 255, 0.7 )' : 'rgba( 0, 0, 0, 0.5 )'

          ctx.beginPath()
          ctx.arc( this.x, this.y, this.size, 0, Math.PI * 2 )
          ctx.fill()
        }
      }

      const initParticles = () => {
        particles = []
        let numberOfParticles = ( canvas.width * canvas.height ) / 9000
        for ( let i = 0; i < numberOfParticles; i++ ) {
          particles.push( new Particle() )
        }
      }

      const connect = () => {
        let opacityValue = 1
        for ( let a = 0; a < particles.length; a++ ) {
          for ( let b = a; b < particles.length; b++ ) {
            let dx = particles[ a ].x - particles[ b ].x
            let dy = particles[ a ].y - particles[ b ].y
            let distance = dx * dx + dy * dy

            if ( distance < ( canvas.width / 7 ) * ( canvas.height / 7 ) ) {
              opacityValue = 1 - ( distance / 20000 )
              const isDark = document.documentElement.classList.contains( 'dark' )

              let strokeColor = isDark
                ? `rgba( 148, 163, 184, ${ opacityValue } )`
                : `rgba( 71, 85, 105, ${ opacityValue } )`

              ctx.strokeStyle = strokeColor
              ctx.lineWidth = 1
              ctx.beginPath()
              ctx.moveTo( particles[ a ].x, particles[ a ].y )
              ctx.lineTo( particles[ b ].x, particles[ b ].y )
              ctx.stroke()
            }
          }
        }
      }

      const animate = () => {
        requestAnimationFrame( animate )
        ctx.clearRect( 0, 0, canvas.width, canvas.height )
        particles.forEach( p => {
          p.update()
          p.draw()
        } )
        connect()
      }

      const resizeCanvas = () => {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
        initParticles()
      }

      window.addEventListener( 'resize', resizeCanvas )
      window.addEventListener( 'mousemove', (e) => {
        mouse.x = e.x
        mouse.y = e.y
      } )
      window.addEventListener( 'mouseout', () => {
        mouse.x = null
        mouse.y = null
      } )

      resizeCanvas()
      animate()
    }
  }
</script>
